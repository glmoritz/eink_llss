openapi: 3.1.0

info:
  title: High Level Screen Service (HLSS) API
  version: 0.1.0
  description: >
    HLSS provides application-specific logic and server-side rendered
    user interfaces for e-Ink devices, mediated by the Low Level Screen
    Service (LLSS). HLSS never communicates directly with devices.

servers:
  - url: https://lichess-hlss.example/api

security:
  - LLSSAuth: []

tags:
  - name: Instances
    description: Instance lifecycle and configuration
  - name: Inputs
    description: Input events forwarded by LLSS
  - name: Frames
    description: Frame metadata and delivery
  - name: Rendering
    description: Frame generation and rendering control

paths:

  /instances/init:
    post:
      tags: [Instances]
      summary: Initialize a new HLSS instance
      description: >
        Called by LLSS when a new instance is created.
        Establishes trust, stores callbacks, and initializes state.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InstanceInitRequest"
      responses:
        "200":
          description: Instance initialized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InstanceInitResponse"

  /instances/{instance_id}/inputs:
    post:
      tags: [Inputs]
      summary: Receive input event from LLSS
      description: >
        Receives abstract button events forwarded by LLSS.
        HLSS updates internal state and may render a new frame.
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InputEvent"
      responses:
        "200":
          description: Input processed

  /instances/{instance_id}/status:
    get:
      tags: [Instances]
      summary: Get instance status
      description: >
        Returns the current status of the instance, including whether
        user configuration is required.
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Instance status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InstanceStatus"

  /instances/{instance_id}:
    delete:
      tags: [Instances]
      summary: Delete an instance
      description: >
        Called by LLSS when an instance is deleted. HLSS should clean up
        all resources associated with this instance (state, cached frames, etc.).
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Instance deleted successfully
        "404":
          description: Instance not found

  /instances/{instance_id}/render:
    post:
      tags: [Rendering]
      summary: Force frame rendering
      description: >
        Optional endpoint allowing LLSS to request a fresh render
        (e.g. after reconnect or cache loss).
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "202":
          description: Render scheduled

  /instances/{instance_id}/frame:
    get:
      tags: [Frames]
      summary: Get current frame metadata
      description: >
        Returns metadata about the current frame for this instance,
        including frame ID, hash, dimensions, and screen type.
        LLSS can use this to check if it has the latest frame.
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Frame metadata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FrameMetadata"
        "404":
          description: Instance not found

  /instances/{instance_id}/frame/send:
    post:
      tags: [Frames]
      summary: Request frame send
      description: >
        Request HLSS to send (or re-send) the current frame to LLSS.
        If a frame exists, it will be submitted via the callback URL.
        If no frame exists, a new one will be rendered and sent.
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Frame send response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FrameSendResponse"
        "404":
          description: Instance not found

components:

  securitySchemes:
    LLSSAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    InstanceInitRequest:
      type: object
      required:
        - instance_id
        - callbacks
        - display
      properties:
        instance_id:
          type: string
        callbacks:
          type: object
          required: [frames, inputs, notify]
          properties:
            frames:
              type: string
              format: uri
            inputs:
              type: string
              format: uri
            notify:
              type: string
              format: uri
        display:
          type: object
          required: [width, height, bit_depth]
          properties:
            width:
              type: integer
            height:
              type: integer
            bit_depth:
              type: integer

    InstanceInitResponse:
      type: object
      required: [status, needs_configuration]
      properties:
        status:
          type: string
          enum: [initialized]
        needs_configuration:
          type: boolean
        configuration_url:
          type: string
          format: uri
          nullable: true

    InstanceStatus:
      type: object
      properties:
        instance_id:
          type: string
        ready:
          type: boolean
        needs_configuration:
          type: boolean
        configuration_url:
          type: string
          format: uri
          nullable: true
        active_screen:
          type: string
          description: >
            Logical screen currently active (e.g. new_match, game_123)

    InputEvent:
      type: object
      required: [button, event_type, timestamp]
      properties:
        button:
          type: string
          enum:
            - BTN_1
            - BTN_2
            - BTN_3
            - BTN_4
            - BTN_5
            - BTN_6
            - BTN_7
            - BTN_8
            - ENTER
            - ESC
            - HL_LEFT
            - HL_RIGHT
        event_type:
          type: string
          enum: [PRESS, LONG_PRESS, RELEASE]
        timestamp:
          type: string
          format: date-time

    FrameMetadata:
      type: object
      required: [instance_id, has_frame]
      properties:
        instance_id:
          type: string
          description: LLSS instance ID
        has_frame:
          type: boolean
          description: Whether a frame exists for this instance
        frame_id:
          type: string
          nullable: true
          description: Internal frame ID
        frame_hash:
          type: string
          nullable: true
          description: SHA256 hash of the frame image
        screen_type:
          type: string
          nullable: true
          description: Current screen type
        width:
          type: integer
          nullable: true
          description: Frame width in pixels
        height:
          type: integer
          nullable: true
          description: Frame height in pixels
        created_at:
          type: string
          format: date-time
          nullable: true
          description: When the frame was created

    FrameSendResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [sent, no_frame, scheduled]
          description: "Send status: 'sent' if existing frame was queued, 'scheduled' if new render was triggered"
        frame_id:
          type: string
          nullable: true
          description: Frame ID that was/will be sent
